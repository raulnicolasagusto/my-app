import{b as P,r as b,bA as k,N as V,u as J,j as $,bB as U,cG as D,cH as x,cI as H,bI as B,cJ as K,cK as z,cL as G}from"./sanity-DLtIshGz.js";import{w as Y,g as F,a as W,b as T,r as X,p as Z,t as ee,c as te,d as re,e as se}from"./PresentationToolGrantsCheck-BsYXDqKS.js";import{i as L}from"./DisplayedDocumentBroadcaster-BEyCkwAD.js";const ne=/^[a-z0-9_]+$/i;function ie(t){if(Array.isArray(t)&&t.includes("raw"))throw new TypeError('Invalid API perspective value: "raw". The raw-perspective can not be combined with other perspectives');const e=(Array.isArray(t)?t:[t]).filter(s=>typeof s!="string"||!ne.test(s));if(e.length>0){const s=e.map(a=>JSON.stringify(a));throw new TypeError(`Invalid API perspective value${e.length===1?"":"s"}: ${s.join(", ")}, expected \`published\`, \`drafts\`, \`raw\` or a release identifier string`)}}function ae(t){if(ie(t),Array.isArray(t))return t.includes("published")?t:[...t,"published"];switch(t){case"previewDrafts":case"drafts":return["drafts","published"];case"published":default:return["published"]}}function ue(t,e){const s=ae(e);function a(r){for(const n of s){let i=null;if(n.startsWith("r")&&(i=t({...r,_id:F(r._id,n)})),n==="drafts"&&(i=t({...r,_id:W(r._id)})),n==="published"&&(i=t({...r,_id:T(r._id)})),i)return{...i,_id:T(i._id),_originalId:i._id}}return null}return function(r){return a(r)}}function oe(t,e,s,a,r){var h,f;if(!e)return t;const n=ue(s,r),i=((f=(h=e.documents)==null?void 0:h.map)==null?void 0:f.call(h,n))||[];return Y(JSON.parse(JSON.stringify(t)),(c,l)=>{const p=X(l,e);if(!p)return c;const{mapping:u,pathSuffix:S}=p;if(u.type!=="value"||u.source.type!=="documentValue")return c;const m=e.documents[u.source.document],I=e.paths[u.source.path];if(m){const g=Z(I+S),v=ee(g),w=i[u.source.document];if(!w)return c;const q=w?te(w,v,c):c;return c===q?c:a(q,{cachedDocument:w,previousValue:c,sourceDocument:m,sourcePath:g})}return c})}function ce(t,e){switch(e.type){case"message":return{...t,messages:[...t.messages,e]};case"reconnect":case"restart":return{...t,messages:[],resets:t.resets+1};case"welcome":return t;default:throw Error(`Unknown event: ${e.type}`,{cause:e})}}const le={messages:[],resets:0};function pe(t){const e=P.c(3),[s,a]=b.useReducer(ce,le),[r,n]=b.useState(null);if(r!==null)throw r;let i,h;return e[0]!==t.live?(i=()=>{const f=t.live.events({includeDrafts:!0,tag:"presentation-loader"}).subscribe({next:a,error:c=>n(c instanceof Error?c:new Error("Unexpected error in useLiveEvents",{cause:c}))});return()=>f.unsubscribe()},h=[t.live],e[0]=t.live,e[1]=i,e[2]=h):(i=e[1],h=e[2]),b.useEffect(i,h),b.useDeferredValue(s)}const fe=(t,{previousValue:e})=>{if(typeof e=="string"){if(typeof t=="number")return`${t}`;if(Array.isArray(t)){if(t.length===0)return"";if(t.some(s=>typeof s=="object"&&z(s)))return G(t)}}return t};function de(t,e,s){return`${t}:${e}:${JSON.stringify(s)}`}function he(t){if(t.queries.size<1)return t;const e=Date.now();if(!Array.from(t.heartbeats.values()).some(r=>r.heartbeat!==!1&&e>r.receivedAt+r.heartbeat))return t;const s=new Map,a=new Map;for(const[r,n]of t.heartbeats.entries())n.heartbeat!==!1&&e>n.receivedAt+n.heartbeat||(s.set(r,n),a.set(r,t.queries.get(r)));return{...t,queries:a,heartbeats:s}}function ye(t,{payload:e}){const s=de(e.perspective,e.query,e.params),a={query:e.query,params:e.params,perspective:e.perspective},r=new Map(t.heartbeats);r.set(s,{receivedAt:Date.now(),heartbeat:e.heartbeat});let n=t.queries;return(!t.queries.has(s)||!L(t.queries.get(s),a))&&(n=new Map(t.queries),n.set(s,a)),{heartbeats:r,queries:n}}function be(t,e){switch(e.type){case"query-listen":return ye(t,e);case"gc":return he(t);default:throw Error(`Unknown action: ${e.type}`,{cause:e})}}const me={queries:new Map,heartbeats:new Map};function ge(){const t=P.c(4),[e,s]=b.useReducer(be,me);let a,r;t[0]===Symbol.for("react.memo_cache_sentinel")?(a=()=>{const h=setInterval(()=>s({type:"gc"}),D);return()=>clearInterval(h)},r=[],t[0]=a,t[1]=r):(a=t[0],r=t[1]),b.useEffect(a,r);const n=b.useDeferredValue(e.queries);let i;return t[2]!==n?(i=[n,s],t[2]=n,t[3]=i):i=t[3],i}function Re(t){const e=P.c(31),{controller:s,perspective:a,onLoadersConnection:r,onDocumentsOnPage:n}=t,[i,h]=b.useState(),[f,c]=ge(),l=k(),p=V();let u,S;e[0]!==s||e[1]!==p||e[2]!==c||e[3]!==n||e[4]!==r||e[5]!==l?(u=()=>{if(s){const R=s.createChannel({name:"presentation",connectTo:"loaders",heartbeat:!0},re().provide({actors:se()}));return h(R),R.onStatus(r),R.on("loader/documents",E=>{E.projectId===l&&E.dataset===p&&n("loaders",E.perspective,E.documents)}),R.on("loader/query-listen",E=>{if(E.projectId===l&&E.dataset===p){if(typeof E.heartbeat=="number"&&E.heartbeat<x)throw new Error(`Loader query listen heartbeat interval must be at least ${x}ms`);c({type:"query-listen",payload:{perspective:E.perspective,query:E.query,params:E.params,heartbeat:E.heartbeat??!1}})}}),R.start()}return Ee},S=[s,p,c,n,r,l],e[0]=s,e[1]=p,e[2]=c,e[3]=n,e[4]=r,e[5]=l,e[6]=u,e[7]=S):(u=e[6],S=e[7]),b.useEffect(u,S);let m;e[8]!==a?(m=K(a)?H:{apiVersion:B},e[8]=a,e[9]=m):m=e[9];const I=J(m);let g,v;e[10]!==I?(v=I.withConfig({resultSourceMap:"withKeyArraySelector"}),e[10]=I,e[11]=v):v=e[11],g=v;const w=g;let q,_;e[12]!==a||e[13]!==i||e[14]!==p||e[15]!==l?(q=()=>{i&&i.post("loader/perspective",{projectId:l,dataset:p,perspective:a})},_=[i,a,l,p],e[12]=a,e[13]=i,e[14]=p,e[15]=l,e[16]=q,e[17]=_):(q=e[16],_=e[17]),b.useEffect(q,_);const M=b.useDeferredValue(t.liveDocument),A=pe(w);let y;e[18]!==f?(y=f.entries(),e[18]=f,e[19]=y):y=e[19];let o;e[20]!==y?(o=[...y],e[20]=y,e[21]=o):o=e[21];let d;return e[22]!==w||e[23]!==i||e[24]!==p||e[25]!==M||e[26]!==A.messages||e[27]!==A.resets||e[28]!==l||e[29]!==o?(d=$.jsx($.Fragment,{children:o.map(R=>{const[E,Q]=R,{query:j,params:N,perspective:O}=Q;return $.jsx(C,{projectId:l,dataset:p,perspective:O,query:j,params:N,comlink:i,client:w,liveDocument:M,liveEventsMessages:A.messages},`${A.resets}:${E}`)})}),e[22]=w,e[23]=i,e[24]=p,e[25]=M,e[26]=A.messages,e[27]=A.resets,e[28]=l,e[29]=o,e[30]=d):d=e[30],d}function Ee(){}function ve(t){const e=P.c(20),{projectId:s,dataset:a,perspective:r,query:n,client:i,liveDocument:h,params:f,comlink:c,liveEventsMessages:l}=t,{result:p,resultSourceMap:u,syncTags:S}=we({client:i,liveDocument:h,params:f,perspective:r,query:n,liveEventsMessages:l})||{};let m;e[0]!==a||e[1]!==s?(m=(w,q,_,M,A,y,o)=>{w==null||w.post("loader/query-change",{projectId:s,dataset:a,perspective:q,query:_,params:M,result:A,resultSourceMap:y,tags:o})},e[0]=a,e[1]=s,e[2]=m):m=e[2];const I=U(m);let g;e[3]!==c||e[4]!==I||e[5]!==f||e[6]!==r||e[7]!==n||e[8]!==p||e[9]!==u||e[10]!==S?(g=()=>{u&&I(c,r,n,f,p,u,S)},e[3]=c,e[4]=I,e[5]=f,e[6]=r,e[7]=n,e[8]=p,e[9]=u,e[10]=S,e[11]=g):g=e[11];let v;return e[12]!==c||e[13]!==f||e[14]!==r||e[15]!==n||e[16]!==p||e[17]!==u||e[18]!==S?(v=[c,f,r,n,p,u,S],e[12]=c,e[13]=f,e[14]=r,e[15]=n,e[16]=p,e[17]=u,e[18]=S,e[19]=v):v=e[19],b.useEffect(g,v),null}const C=b.memo(ve);C.displayName="Memo(QuerySubscription)";function we(t){const e=P.c(30),{liveDocument:s,client:a,query:r,params:n,perspective:i,liveEventsMessages:h}=t,[f,c]=b.useState(null),[l,p]=b.useState(null),[u,S]=b.useState(void 0);let m;e[0]!==h?(m=()=>new Set(h.map(Se)),e[0]=h,e[1]=m):m=e[1];const[I]=b.useState(m);let g;if(e[2]!==h||e[3]!==I||e[4]!==u){let y;e[6]!==I?(y=R=>!I.has(R.id),e[6]=I,e[7]=y):y=e[7];const o=h.filter(y);let d;e[8]!==u?(d=R=>R.tags.some(E=>u==null?void 0:u.includes(E)),e[8]=u,e[9]=d):d=e[9],g=o.findLast(d),e[2]=h,e[3]=I,e[4]=u,e[5]=g}else g=e[5];const v=g==null?void 0:g.id,[w,q]=b.useState(null);if(w)throw w;let _,M;e[10]!==a||e[11]!==v||e[12]!==n||e[13]!==i||e[14]!==r?(_=()=>{const y=new AbortController;return a.fetch(r,n,{lastLiveEventId:v,tag:"presentation-loader",signal:y.signal,perspective:i,filterResponse:!1,returnQuery:!1}).then(o=>{b.startTransition(()=>{c(d=>L(d,o.result)?d:o.result),p(d=>L(d,o.resultSourceMap)?d:o.resultSourceMap),S(d=>L(d,o.syncTags)?d:o.syncTags)})}).catch(o=>{(typeof o!="object"||(o==null?void 0:o.name)!=="AbortError")&&q(o)}),()=>{y.abort()}},M=[a,v,n,i,r],e[10]=a,e[11]=v,e[12]=n,e[13]=i,e[14]=r,e[15]=_,e[16]=M):(_=e[15],M=e[16]),b.useEffect(_,M);let A;e:{if(s&&l){let o;e[17]!==s||e[18]!==i||e[19]!==f||e[20]!==l?(o=Ie(s,f,i,l),e[17]=s,e[18]=i,e[19]=f,e[20]=l,e[21]=o):o=e[21];let d;e[22]!==l||e[23]!==u||e[24]!==o?(d={result:o,resultSourceMap:l,syncTags:u},e[22]=l,e[23]=u,e[24]=o,e[25]=d):d=e[25],A=d;break e}let y;e[26]!==f||e[27]!==l||e[28]!==u?(y={result:f,resultSourceMap:l,syncTags:u},e[26]=f,e[27]=l,e[28]=u,e[29]=y):y=e[29],A=y}return A}function Se(t){return t.id}function Ie(t,e,s,a){if(s==="raw")throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return oe(e,a,r=>!r._projectId&&(t!=null&&t._id)&&T(t._id)===T(r._id)?typeof t._id=="string"&&typeof r._type=="string"?t:{...t,_id:t._id||r._id,_type:t._type||r._type}:null,fe,s)}export{Re as default,Ie as turboChargeResultIfSourceMap};
